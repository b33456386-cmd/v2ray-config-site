<script>
let data = [];
let originalData = [];

async function loadConfigs(){
    document.getElementById("countries").innerHTML="â³ Ø¯Ø± Ø­Ø§Ù„ Ø¯Ø±ÛŒØ§ÙØª...";

    try{
        const url = "https://raw.githubusercontent.com/mahdibland/V2RayAggregator/master/sub/sub_merge.txt";

        // Ú¯Ø±ÙØªÙ† Ù‡Ù…Ø²Ù…Ø§Ù† Ù…ØªÙ† + Ù‡Ø¯Ø±
        const res = await fetch(url + "?" + Date.now());

        // â± Ú¯Ø±ÙØªÙ† Ø²Ù…Ø§Ù† ÙˆØ§Ù‚Ø¹ÛŒ Ø¢Ù¾Ø¯ÛŒØª Ø§Ø² Ù‡Ø¯Ø±
        const lastModified = res.headers.get("Last-Modified");

        if(lastModified){
            const date = new Date(lastModified);
            showRealUpdateTime(date);
        }

        const text = await res.text();
        const lines = text.split("\n");

        let usa = [];
        let germany = [];

        lines.forEach(line=>{
            if(line.includes("US") || line.includes("United States")){
                usa.push(line);
            }
            if(line.includes("DE") || line.includes("Germany")){
                germany.push(line);
            }
        });

        data = [
            {name:"ğŸ‡ºğŸ‡¸ Ø¢Ù…Ø±ÛŒÚ©Ø§", configs: usa.slice(0,10)},
            {name:"ğŸ‡©ğŸ‡ª Ø¢Ù„Ù…Ø§Ù†", configs: germany.slice(0,10)}
        ];

        originalData = JSON.parse(JSON.stringify(data));

        showCountries();

    }catch(e){
        document.getElementById("countries").innerHTML="âŒ Ø®Ø·Ø§ Ø¯Ø± Ø¯Ø±ÛŒØ§ÙØª";
    }
}

// â± ØªØ¨Ø¯ÛŒÙ„ Ø¨Ù‡ Ø³Ø§Ø¹Øª Ø§ÛŒØ±Ø§Ù† (ÙÙ‚Ø· Ø³Ø§Ø¹Øª Ùˆ Ø¯Ù‚ÛŒÙ‚Ù‡)
function showRealUpdateTime(date){
    const iranTime = date.toLocaleTimeString("fa-IR", {
        timeZone: "Asia/Tehran",
        hour: "2-digit",
        minute: "2-digit"
    });

    document.getElementById("lastUpdate").innerText =
        "ğŸ•’ Ø¢Ø®Ø±ÛŒÙ† Ø¢Ù¾Ø¯ÛŒØª ÙˆØ§Ù‚Ø¹ÛŒ Ú©Ø§Ù†ÙÛŒÚ¯: " + iranTime;
}

function showCountries(){
    let html="";

    data.forEach((country,index)=>{
        html+=`
        <div class="box">
            <h3>${country.name} (${country.configs.length})</h3>

            <button onclick="toggleConfigs(${index})">
                Ù†Ù…Ø§ÛŒØ´ Ú©Ø§Ù†ÙÛŒÚ¯â€ŒÙ‡Ø§
            </button>

            <button class="sub" onclick="copySub(${index})">
                ğŸ“¡ Ú©Ù¾ÛŒ Ø³Ø§Ø¨Ø³Ú©Ø±ÛŒÙ¾Ø´Ù†
            </button>

            <div id="list${index}"></div>
        </div>
        `;
    });

    document.getElementById("countries").innerHTML=html;
}

function toggleConfigs(index){
    let container = document.getElementById("list"+index);

    if(container.innerHTML !== ""){
        container.innerHTML="";
        return;
    }

    let configs = data[index].configs;
    let html="";

    configs.forEach(c=>{
        html+=`
        <div class="config">
            ${c}
            <br>
            <button class="copy" onclick="copyConfig('${c}')">Ú©Ù¾ÛŒ</button>
        </div>
        `;
    });

    container.innerHTML=html;
}

function copyConfig(text){
    navigator.clipboard.writeText(text);
    alert("âœ… Ú©Ù¾ÛŒ Ø´Ø¯");
}

function copySub(index){
    let list = data[index].configs.join("\n");
    navigator.clipboard.writeText(list);
    alert("ğŸ“¡ Ø³Ø§Ø¨Ø³Ú©Ø±ÛŒÙ¾Ø´Ù† Ú©Ù¾ÛŒ Ø´Ø¯");
}

function searchData(){
    let value = document.getElementById("search").value.toLowerCase();

    data = originalData.map(country=>{
        return {
            name: country.name,
            configs: country.configs.filter(c => 
                c.toLowerCase().includes(value) || country.name.toLowerCase().includes(value)
            )
        };
    });

    showCountries();
}

// â± Ù‡Ø± Û³ Ø³Ø§Ø¹Øª
setInterval(loadConfigs, 10800000);

loadConfigs();
       </script>
