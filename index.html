<script>

let data=[];
let opened=null;

function getTime(){
return new Date().toLocaleTimeString("fa-IR",{timeZone:"Asia/Tehran"});
}

// Ú©Ù¾ÛŒ Ø³Ø§Ø²Ú¯Ø§Ø± Ø¨Ø§ Ù‡Ù…Ù‡ Ú¯ÙˆØ´ÛŒâ€ŒÙ‡Ø§
function copyText(text){
if(navigator.clipboard){
navigator.clipboard.writeText(text);
}else{
let t=document.createElement("textarea");
t.value=text;
document.body.appendChild(t);
t.select();
document.execCommand("copy");
document.body.removeChild(t);
}
alert("Ú©Ù¾ÛŒ Ø´Ø¯ âœ…");
}

function safeDecode(t){
try{return atob(t.trim())}catch{return t}
}

async function loadConfigs(){

document.getElementById("countries").innerHTML="â³ Ø¯Ø± Ø­Ø§Ù„ Ø¯Ø±ÛŒØ§ÙØª...";

try{

const urls=[
"https://raw.githubusercontent.com/v2fly/free-nodes/main/sub",
"https://raw.githubusercontent.com/mahdibland/V2RayAggregator/master/sub/sub_merge_base64.txt"
];

let all=[];

for(let u of urls){
try{
let r=await fetch(u);
let t=await r.text();
t=safeDecode(t);
all=all.concat(t.split("\n"));
}catch{}
}

all=all.filter(x=>x.startsWith("vmess")||x.startsWith("vless")||x.startsWith("trojan"));

let usa=[],de=[];

all.forEach(c=>{
let x=c.toLowerCase();
if(x.includes("us")) usa.push(c);
if(x.includes("de")) de.push(c);
});

data=[
{name:"Ø¢Ù…Ø±ÛŒÚ©Ø§",configs:usa.slice(0,50)},
{name:"Ø¢Ù„Ù…Ø§Ù†",configs:de.slice(0,50)}
];

document.getElementById("lastUpdate").innerText="Ø¢Ø®Ø±ÛŒÙ† Ø¢Ù¾Ø¯ÛŒØª: "+getTime();

show();

}catch(e){
document.getElementById("countries").innerHTML="âŒ Ø®Ø·Ø§ Ø¯Ø± Ø¯Ø±ÛŒØ§ÙØª";
console.log(e);
}
}

function show(filteredData=null){

let div=document.getElementById("countries");
div.innerHTML="";

let listData = filteredData || data;

listData.forEach(c=>{
let wrap=document.createElement("div");

let btn=document.createElement("button");
btn.className="country";
btn.innerText=(c.name==="Ø¢Ù…Ø±ÛŒÚ©Ø§"?"ðŸ‡ºðŸ‡¸ ":"ðŸ‡©ðŸ‡ª ")+c.name+" ("+c.configs.length+")";

let list=document.createElement("div");
list.className="list";

btn.onclick=()=>{
if(opened&&opened!==list) opened.classList.remove("open");
list.classList.toggle("open");
opened=list;
};

// Ú©Ù¾ÛŒ Ù‡Ù…Ù‡
let allBtn=document.createElement("button");
allBtn.className="update";
allBtn.innerText="ðŸ“‹ Ú©Ù¾ÛŒ Ù‡Ù…Ù‡";
allBtn.onclick=()=>copyText(c.configs.join("\n"));
list.appendChild(allBtn);

// Ù‡Ø± Ú©Ø§Ù†ÙÛŒÚ¯
c.configs.forEach(cfg=>{
let card=document.createElement("div");
card.className="card";

let t=document.createElement("div");
t.innerText=cfg;

let copy=document.createElement("button");
copy.className="copy";
copy.innerText="Ú©Ù¾ÛŒ";
copy.onclick=()=>copyText(cfg);

card.appendChild(t);
card.appendChild(copy);
list.appendChild(card);
});

wrap.appendChild(btn);
wrap.appendChild(list);
div.appendChild(wrap);
});
}

// Ø¬Ø³ØªØ¬ÙˆÛŒ Ø­Ø±ÙÙ‡â€ŒØ§ÛŒ (Ú©Ø´ÙˆØ± + Ú©Ø§Ù†ÙÛŒÚ¯)
function searchConfigs(){

let v=document.getElementById("search").value.toLowerCase();

if(!v){
show();
return;
}

let result = data.map(c=>{

// Ø§Ú¯Ø± Ø§Ø³Ù… Ú©Ø´ÙˆØ± Ù…Ú† Ø´Ø¯ â†’ Ù‡Ù…Ù‡ Ø±Ùˆ Ù†Ø´ÙˆÙ† Ø¨Ø¯Ù‡
if(c.name.toLowerCase().includes(v)){
return c;
}

// ÙÛŒÙ„ØªØ± Ú©Ø§Ù†ÙÛŒÚ¯â€ŒÙ‡Ø§
let filtered = c.configs.filter(cfg=>cfg.toLowerCase().includes(v));

return {
name:c.name,
configs:filtered
};

}).filter(c=>c.configs.length>0);

show(result);
}

loadConfigs();

</script>
