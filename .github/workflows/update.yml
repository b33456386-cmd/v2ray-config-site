name: Update Configs

on:
  schedule:
    - cron: "0 */3 * * *"
  workflow_dispatch:

jobs:
  update:
    runs-on: ubuntu-latest

    steps:
      - uses: actions/checkout@v3

      - name: Fetch configs
        run: curl -o data.txt https://raw.githubusercontent.com/barry-far/V2ray-Configs/main/Sub1.txt

      - name: Make JSON safely
        run: |
          usa=$(grep "US" data.txt | head -n 10 | sed 's/"/\\"/g' | sed 's/^/"/;s/$/"/' | paste -sd, -)
          de=$(grep "DE" data.txt | head -n 10 | sed 's/"/\\"/g' | sed 's/^/"/;s/$/"/' | paste -sd, -)

          [ -z "$usa" ] && usa=""
          [ -z "$de" ] && de=""

          echo "{\"usa\":[${usa}],\"germany\":[${de}]}" > configs.json

      - name: Commit & Push
        run: |
          git config --global user.name "bot"
          git config --global user.email "bot@example.com"
          git add configs.json
          git commit -m "update configs" || echo "no changes"
          git push
